<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta LP2B Lombok Timur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<!-- html2pdf -->
<script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>

<style>
:root{--bg-color:#f1f8f4;--text-color:#1b5e20;--card-bg:#fff;--border-color:#c8e6c9;}
body.dark{--bg-color:#121212;--text-color:#c8e6c9;--card-bg:#1f1f1f;--border-color:#333;}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:var(--bg-color);color:var(--text-color);}
#container{display:flex;height:100%;}
#story{width:32%;height:100%;padding:15px;overflow-y:auto;background:var(--bg-color);border-right:2px solid var(--border-color);}
#story h2{margin-top:0;color:var(--text-color);}
.story-item{background:var(--card-bg);padding:12px;margin-bottom:15px;border-left:6px solid #2e7d32;cursor:pointer;color:var(--text-color);transition: all 0.2s ease;}
.story-item:hover{opacity:1;background-color:#e8f5e9;transform: translateX(3px);box-shadow:2px 2px 5px rgba(0,0,0,0.2);}
.story-item.active{border-left-color:#ff5722;background-color:#c8e6c9;}
.story-item.active:hover{background-color:#aed581;transform: translateX(3px);box-shadow:2px 2px 5px rgba(0,0,0,0.2);}
#map{width:68%;height:100%;}
#chart-container{width:100%;height:200px;margin-top:10px;background:var(--card-bg);padding:10px;border:1px solid var(--border-color);}
#filters{margin-top:10px;background:var(--card-bg);padding:10px;border:1px solid var(--border-color);}
#export-btn{margin-top:10px;padding:8px 12px;background:#2e7d32;color:#fff;border:none;cursor:pointer;border-radius:4px;}
#export-btn:hover{background:#1b5e20;}
#legend{background:var(--card-bg);padding:10px;border:1px solid var(--border-color);margin-top:10px;}
.legend-item{cursor:pointer;padding:2px;margin:2px;display:flex;align-items:center;}
.legend-color{width:20px;height:20px;margin-right:5px;display:inline-block;border:1px solid #000;}
#footer{text-align:center;padding:10px;background:var(--card-bg);border-top:1px solid var(--border-color);margin-top:10px;font-size:14px;color:var(--text-color);}
#themeToggle{margin-top:10px;padding:5px 8px;border:none;background:#2e7d32;color:#fff;border-radius:4px;cursor:pointer;}
#themeToggle:hover{background:#1b5e20;}
#searchContainer{margin-top:10px;padding:10px;background:var(--card-bg);border:1px solid var(--border-color);}
#searchContainer input{width:70%;padding:5px;margin-right:5px;border:1px solid var(--border-color);border-radius:4px;}
#searchContainer button{padding:5px 8px;background:#2e7d32;color:#fff;border:none;border-radius:4px;cursor:pointer;}
#searchContainer button:hover{background:#1b5e20;}
@media(max-width:768px){#container{flex-direction:column;}#story{width:100%;height:50%;}#map{width:100%;height:50%;}}
</style>
</head>
<body>
<div id="container">
<div id="story">
<h2>Peta LP2B Lombok Timur</h2>

<div class="story-item" id="menuBatas" onclick="toggleLayerZoom(batasLayer,this)"><b>KECAMATAN</b></div>
<div class="story-item" id="menuLP2B" onclick="toggleLayerZoom(lp2bLayer,this)"><b>LP2B</b></div>
<div class="story-item" id="menuLBS" onclick="toggleLayerZoom(lbsLayer,this)"><b>LBS</b></div>
<div class="story-item" id="menuRTRW" onclick="toggleLayerZoom(rtrwLayer,this)"><b>RTRW</b></div>
<div class="story-item" id="menuKonflik" onclick="toggleLayerZoom(konflikLayer,this)"><b>IRISAN</b></div>

<div id="filters">
  <b>Filter Kecamatan :</b>
  <select id="filterKecamatan"><option value="ALL">Semua</option></select>
  <br><br>
  <b>Filter Zona RTRW :</b>
  <select id="filterZona"><option value="ALL">Semua</option></select>
</div>

<div id="searchContainer">
  <b>Cari Titik (lat, lng):</b><br>
  <input type="text" id="coordInput" placeholder="-8.65,116.5">
  <button onclick="searchCoord()">Cari</button>
</div>

<button id="themeToggle" onclick="toggleTheme()">Gelap/Terang</button>

<div id="legend"><b>Legenda (klik untuk hide/show layer)</b><br></div>

<div id="chart-container"><canvas id="luasChart"></canvas></div>
<button id="export-btn" onclick="exportPDF()">Export PDF Laporan</button>

<div id="footer">Developed by <a href="https://www.facebook.com/share/1C8bjd7Xoh" target="_blank">Ariadi Forester</a></div>
</div>

<div id="map"></div>
</div>

<script>
// ===== Peta =====
var map = L.map('map').setView([-8.65,116.5],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);

// Styles
const styleBatas={color:'#000',weight:1,fillOpacity:0};
const styleLP2B={color:'#1b5e20',fillColor:'#4caf50',fillOpacity:0.6,weight:1};
const styleLBS={color:'#0d47a1',fillColor:'#64b5f6',fillOpacity:0.6,weight:1};
const styleRTRWBase={weight:1,fillOpacity:0.5,color:'#e65100'};
const styleKonflikBase={color:'#b71c1c',fillOpacity:0.7,weight:1};

// Layers
var batasLayer, lp2bLayer, lbsLayer, rtrwLayer, konflikLayer;

// Helper
function popupAll(feature){
  let html='';
  for(let k in feature.properties){ html+=`<b>${k}</b>: ${feature.properties[k]}<br>`;}
  return html;
}

// Toggle layer dari sidebar
function toggleLayerZoom(layer, menuDiv){
  if(!layer) return;
  if(map.hasLayer(layer)){
    map.removeLayer(layer);
    menuDiv.classList.remove('active');
  } else{
    layer.addTo(map);
    map.fitBounds(layer.getBounds());
    menuDiv.classList.add('active');
  }
}

// Load semua GeoJSON
Promise.all([
  fetch('data/batas_kecamatan_lombok_timur.json').then(r=>r.json()),
  fetch('data/lp2b_lombok_timur.json').then(r=>r.json()),
  fetch('data/lbs_lombok_timur.json').then(r=>r.json()),
  fetch('data/rtrw_lombok_timur.json').then(r=>r.json()),
  fetch('data/konflik_lp2b_rtrw.json').then(r=>r.json())  // file konflik precomputed
]).then(([batasData,lp2bData,lbsData,rtrwData,konflikData])=>{

  // Layer utama
  batasLayer=L.geoJSON(batasData,{style:styleBatas,onEachFeature:(f,l)=>l.bindPopup(popupAll(f))}).addTo(map);
  lp2bLayer=L.geoJSON(lp2bData,{style:styleLP2B,onEachFeature:(f,l)=>l.bindPopup(popupAll(f))}).addTo(map);
  lbsLayer=L.geoJSON(lbsData,{style:styleLBS,onEachFeature:(f,l)=>l.bindPopup(popupAll(f))}).addTo(map);

  // RTRW
  let zonaSet=new Set();
  rtrwLayer=L.geoJSON(rtrwData,{
    style:feature=>{
      const zona=feature.properties.Pola_Ruang||'LAINNYA';
      zonaSet.add(zona);
      let color='#ffb74d';
      if(zona.toLowerCase().includes('pertanian')) color='#4caf50';
      else if(zona.toLowerCase().includes('pemukiman')) color='#90a4ae';
      else if(zona.toLowerCase().includes('hutan')) color='#2e7d32';
      return {...styleRTRWBase,fillColor:color};
    },
    onEachFeature:(f,l)=>l.bindPopup(popupAll(f))
  }).addTo(map);

  // Dropdown filter
  const filterZona=document.getElementById('filterZona');
  Array.from(zonaSet).sort().forEach(z=>{
    const opt=document.createElement('option'); opt.value=z; opt.text=z; filterZona.appendChild(opt);
  });
  let kecSet=new Set();
  batasData.features.forEach(f=>kecSet.add(f.properties.Kecamatan));
  const filterKecamatan=document.getElementById('filterKecamatan');
  Array.from(kecSet).sort().forEach(k=>{
    const opt=document.createElement('option'); opt.value=k; opt.text=k; filterKecamatan.appendChild(opt);
  });

  filterZona.addEventListener('change',filterMap);
  filterKecamatan.addEventListener('change',filterMap);

  function filterMap(){
    const kec=filterKecamatan.value;
    const zona=filterZona.value;
    rtrwLayer.eachLayer(l=>{
      const show=(zona==='ALL' || l.feature.properties.Pola_Ruang===zona);
      l.setStyle({...l.options,fillOpacity:show?0.5:0,opacity:show?1:0});
    });
    batasLayer.eachLayer(l=>{
      const show=(kec==='ALL' || l.feature.properties.Kecamatan===kec);
      l.setStyle({...l.options,opacity:show?1:0});
    });
    if(konflikLayer){
      konflikLayer.eachLayer(l=> l.setStyle(l.options));
    }
  }

  // Layer konflik precomputed
  konflikLayer=L.geoJSON(konflikData,{
    style:f=>{
      const intensity=f.properties.luas_ha/Math.max(...konflikData.features.map(f=>f.properties.luas_ha));
      const fillColor=`rgba(255,0,0,${0.4 + 0.6*intensity})`;
      return {...styleKonflikBase,fillColor};
    },
    onEachFeature:(f,l)=>{
      l.bindPopup('<b>Konflik LP2B vs RTRW</b><br>Luas: '+f.properties.luas_ha.toFixed(2)+' ha<br>Zona: '+(f.properties.Pola_Ruang||'LAINNYA'));
      l.on('mouseover',()=>l.openPopup());
      l.on('mouseout',()=>l.closePopup());
    }
  }).addTo(map);

  // Chart
  function calcLuas(fc){return fc.features.reduce((sum,f)=>sum+f.properties.luas_ha*10000||0,0)/10000;}
  const chartData=[calcLuas(lp2bData),calcLuas(rtrwData),calcLuas(konflikData)];
  const ctx=document.getElementById('luasChart').getContext('2d');
  new Chart(ctx,{type:'bar',data:{labels:['LP2B (ha)','RTRW (ha)','Konflik (ha)'],datasets:[{label:'Luas',data:chartData,backgroundColor:['#4caf50','#ffb74d','#f44336'] }]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

  // Legend
  function updateLegend(){
    const legendDiv=document.getElementById('legend');
    legendDiv.innerHTML='<b>Legenda (klik untuk hide/show layer)</b><br>';

    const mainLayers=[
      {name:'Batas Kecamatan',layer:batasLayer,color:'#000'},
      {name:'LP2B',layer:lp2bLayer,color:'#4caf50'},
      {name:'LBS',layer:lbsLayer,color:'#64b5f6'},
      {name:'RTRW',layer:rtrwLayer,color:'#ffb74d'},
      {name:'Konflik Heatmap',layer:konflikLayer,color:'#f44336'}
    ];

    mainLayers.forEach(obj=>{
      const div=document.createElement('div'); div.className='legend-item';
      div.innerHTML=`<span class="legend-color" style="background:${obj.color}"></span>${obj.name}`;
      div.onclick=()=>{ if(map.hasLayer(obj.layer)){ map.removeLayer(obj.layer); div.style.opacity=0.5;} else{ obj.layer.addTo(map); div.style.opacity=1;} };
      legendDiv.appendChild(div);
    });

    // Zona RTRW legend
    const zonaColors={};
    rtrwLayer.eachLayer(l=>{ zonaColors[l.feature.properties.Pola_Ruang||'LAINNYA']=l.options.fillColor; });
    Object.keys(zonaColors).sort().forEach(z=>{
      const div=document.createElement('div'); div.className='legend-item';
      div.innerHTML=`<span class="legend-color" style="background:${zonaColors[z]}"></span>Zona: ${z}`;
      div.onclick=()=>{
        rtrwLayer.eachLayer(l=>{
          if(l.feature.properties.Pola_Ruang===z){
            const visible = l.options.fillOpacity>0;
            l.setStyle({...l.options,fillOpacity:visible?0:0.5,opacity:visible?0:1});
          }
        });
      };
      legendDiv.appendChild(div);
    });
  }
  updateLegend();

});

// Export PDF
function exportPDF(){ html2pdf().set({margin:0.5,filename:'storymap_lp2b_lombok_timur_heatmap.pdf',html2canvas:{scale:2},jsPDF:{orientation:'landscape'}}).from(document.getElementById('container')).save();}

// Theme
function toggleTheme(){document.body.classList.toggle('dark');}

// Search koordinat
function searchCoord(){
  const val=document.getElementById('coordInput').value;
  const parts=val.split(',').map(Number);
  if(parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])){
    map.setView([parts[0],parts[1]],15);
    L.marker([parts[0],parts[1]]).addTo(map).bindPopup('Titik dicari').openPopup();
  } else { alert('Format salah! Gunakan: lat,lng'); }
}
</script>
</body>
</html>
