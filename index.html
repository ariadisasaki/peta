<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>WebGIS Distan Lotim</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="leaflet/leaflet.css">
<script src="leaflet/leaflet.js"></script>

<!-- Offline geospatial & PDF libraries -->
<script src="libs/turf.min.js"></script>
<script src="libs/jspdf.min.js"></script>
<script src="libs/jspdf.plugin.autotable.js"></script>
<script src="libs/chart.min.js"></script>

<style>
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#map { height:100%; width:100%; }

/* Panel koordinat */
#coord-search {
  position:fixed; top:10px; left:10px; z-index:1000;
  background:#fff; padding:10px; border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3); transition:0.25s; font-size:13px;
}
#coord-search:hover { transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,0.35);}
#coord-search button { margin-top:4px; padding:4px 8px; cursor:pointer; background:#ecf0f1; border:1px solid #ccc; transition:0.2s;}
#coord-search button:hover { background:#3498db; color:#fff;}

/* Toggle dark/light */
#theme-toggle { position:fixed; top:10px; right:10px; z-index:1200; background:#fff; padding:8px 10px; border-radius:50%; cursor:pointer; font-size:16px; box-shadow:0 2px 6px rgba(0,0,0,0.3); transition:0.3s;}
#theme-toggle:hover { transform:rotate(15deg); }

/* Layer hover */
.leaflet-control-layers { transition:0.25s;}
.leaflet-control-layers:hover { box-shadow:0 6px 14px rgba(0,0,0,0.35);}
.leaflet-control-layers label:hover { background: rgba(52,152,219,0.15); }

/* Footer */
footer { position:fixed; bottom:0; left:0; width:100%; background:#2c3e50; color:#fff; text-align:center; padding:6px 0; font-size:12px; z-index:999;}
footer a { color:#1abc9c; font-weight:bold; text-decoration:none; }
footer a:hover { color:#fff; text-decoration:underline; }

/* Dark mode */
body.dark { background:#1e1e1e; color:#ecf0f1; }
body.dark #coord-search, body.dark .leaflet-control-layers, body.dark #theme-toggle { background:#2c2c2c; color:#ecf0f1; }
body.dark footer { background:#111; }
body.dark button { background:#34495e; color:#ecf0f1; border-color:#555;}
body.dark button:hover { background:#2980b9; }

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width:480px){
  #coord-search { font-size:11px; padding:6px; }
  #coord-search input { width:70px; }
  #theme-toggle { font-size:14px; padding:6px; }
  #coord-search button { padding:3px 6px; font-size:12px; }
  #grafik { width:100%; height:200px; }
  button { font-size:12px; padding:4px 6px; }
}
</style>
</head>
<body>

<!-- Panel koordinat -->
<div id="coord-search">
  <b>Cari Koordinat</b><br>
  <input id="lat" type="number" step="any" placeholder="Latitude">
  <input id="lng" type="number" step="any" placeholder="Longitude"><br>
  <button onclick="cariKoordinat()">Cari</button>
  <button onclick="hapusMarker()">Hapus</button>
</div>

<!-- Toggle dark/light -->
<div id="theme-toggle" onclick="toggleTheme()">ðŸŒ™</div>

<!-- Map -->
<div id="map"></div>

<!-- Chart canvas untuk PDF -->
<canvas id="grafik" width="800" height="300" style="display:none;"></canvas>

<!-- Export PDF -->
<button onclick="exportPDF()" style="position:fixed;top:80px;right:10px;z-index:1200;">ðŸ“„ Export PDF</button>

<footer>
Developed by
<a href="https://www.facebook.com/share/1C8bjd7Xoh" target="_blank">Ariadi Forester</a>
</footer>

<script>
// ================= MAP INIT =================
var map = L.map('map').setView([-8.65,116.53],10);
L.tileLayer('tiles/{z}/{x}/{y}.png',{maxZoom:18, attribution:'Basemap Offline'}).addTo(map);

// ================= STYLE =================
const styleKecamatan = { color:'#000', weight:1, fillOpacity:0 };
const styleLBS  = { color:'#2ecc71', fillOpacity:0.5 };
const styleLP2B = { color:'#3498db', fillOpacity:0.5 };
const styleLSD  = { color:'#f1c40f', fillOpacity:0.6 };
const styleRTRW = { color:'#e74c3c', fillOpacity:0.4 };

// ================= LAYERS =================
var batas = L.geoJSON(null,{style:styleKecamatan}).addTo(map);
var lbs   = L.geoJSON(null,{style:styleLBS}).addTo(map);
var lp2b  = L.geoJSON(null,{style:styleLP2B}).addTo(map);
var lsd   = L.geoJSON(null,{style:styleLSD}).addTo(map);
var rtrw  = L.geoJSON(null,{style:styleRTRW}).addTo(map);

// Konflik layers
var konflikLSDLayer = L.geoJSON(null,{style:{color:"#ff0000",weight:2,fillOpacity:0.7}}).addTo(map);
var konflikLP2RtrwLayer = L.geoJSON(null,{style:{color:"#ff6600",weight:2,fillOpacity:0.7}}).addTo(map);

// ================= FETCH DATA =================
Promise.all([
  fetch("data/batas_kecamatan_lombok_timur.json").then(r=>r.json()),
  fetch("data/lbs_lombok_timur.json").then(r=>r.json()),
  fetch("data/lp2b_lombok_timur.json").then(r=>r.json()),
  fetch("data/lsd_lombok_timur.json").then(r=>r.json()),
  fetch("data/rtrw_lombok_timur.json").then(r=>r.json())
]).then(([batasData,lbsData,lp2bData,lsdData,rtrwData])=>{
  
  batas.addData(batasData);
  lbs.addData(lbsData);
  lp2b.addData(lp2bData);
  lsd.addData(lsdData);
  rtrw.addData(rtrwData);

  // Konflik LSD vs RTRW
  lsdData.features.forEach(lsdF=>{
    rtrwData.features.forEach(rtrwF=>{
      let k = turf.intersect(lsdF,rtrwF);
      if(k) konflikLSDLayer.addData(k);
    });
  });

  // Konflik LP2B vs RTRW
  lp2bData.features.forEach(lp2bF=>{
    rtrwData.features.forEach(rtrwF=>{
      let k = turf.intersect(lp2bF,rtrwF);
      if(k) konflikLP2RtrwLayer.addData(k);
    });
  });

  // Statistik LSD per kecamatan
  var statistikLSD = {};
  batasData.features.forEach(kec=>{
    let nama = kec.properties.nama_kecamatan;
    statistikLSD[nama] = 0;
    lsdData.features.forEach(lsdF=>{
      let irisan = turf.intersect(lsdF,kec);
      if(irisan) statistikLSD[nama]+=turf.area(irisan)/10000;
    });
  });

  // Statistik LP2B per kecamatan
  var statistikLP2B = {};
  batasData.features.forEach(kec=>{
    let nama = kec.properties.nama_kecamatan;
    statistikLP2B[nama] = 0;
    lp2bData.features.forEach(lp2bF=>{
      let irisan = turf.intersect(lp2bF,kec);
      if(irisan) statistikLP2B[nama]+=turf.area(irisan)/10000;
    });
  });

  // Ranking LSD
  rankingKecamatan = Object.entries(statistikLSD).map(([nama,luas])=>({nama,luas})).sort((a,b)=>b.luas-a.luas);
  generateChart(rankingKecamatan);

});

// ================= LAYER CONTROL =================
L.control.layers(null,{
    "Batas Kecamatan": batas,
    "Lahan Baku Sawah (LBS)": lbs,
    "LP2B": lp2b,
    "Lahan Sawah Dilindungi (LSD)": lsd,
    "RTRW": rtrw,
    "Konflik LSD vs RTRW": konflikLSDLayer,
    "Konflik LP2B vs RTRW": konflikLP2RtrwLayer
}).addTo(map);

// ================= KOORDINAT SEARCH =================
var markerKoordinat;
function cariKoordinat(){
  let lat=parseFloat(document.getElementById("lat").value);
  let lng=parseFloat(document.getElementById("lng").value);
  if(isNaN(lat)||isNaN(lng)){ alert("Koordinat tidak valid"); return;}
  if(markerKoordinat) map.removeLayer(markerKoordinat);
  markerKoordinat = L.marker([lat,lng]).addTo(map)
    .bindPopup("Latitude: "+lat+"<br>Longitude: "+lng).openPopup();
  map.setView([lat,lng],16);
}
function hapusMarker(){ if(markerKoordinat){ map.removeLayer(markerKoordinat); markerKoordinat=null; } }

// ================= THEME TOGGLE =================
function toggleTheme(){
  document.body.classList.toggle("dark");
  document.getElementById("theme-toggle").innerHTML = document.body.classList.contains("dark")?"â˜€ï¸":"ðŸŒ™";
}

// ================= GRAFIK =================
function generateChart(ranking){
  const ctx=document.getElementById("grafik").getContext("2d");
  const labels=ranking.map(r=>r.nama);
  const data=ranking.map(r=>r.luas);
  return new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{label:'Luas LSD (ha)', data, backgroundColor:'#3498db'}]},
    options:{ responsive:false, scales:{y:{beginAtZero:true}}}
  });
}

// ================= PDF =================
function exportPDF(){
  const doc = new jsPDF('landscape','mm','a3');
  const margin = 20;

  // Cover
  doc.setFontSize(22);
  doc.text("LAPORAN ANALISIS LAHAN SAWAH DILINDUNGI", doc.internal.pageSize.getWidth()/2, 50, {align:'center'});
  doc.setFontSize(16);
  doc.text("Kabupaten Lombok Timur â€“ Permen ATR", doc.internal.pageSize.getWidth()/2, 70, {align:'center'});

  doc.addPage();

  // Ranking table
  doc.setFontSize(14);
  doc.text("Ranking Kecamatan Rawan LSD", margin, 30);
  const tableData = rankingKecamatan.map((r,i)=>[i+1,r.nama,r.luas.toFixed(2)+' ha']);
  doc.autoTable({ startY:40, head:[["No","Kecamatan","Luas LSD (ha)"]], body:tableData });

  // Grafik
  const canvas=document.getElementById("grafik");
  canvas.style.display='block';
  const chartData = canvas.toDataURL("image/png",1.0);
  doc.addPage();
  doc.addImage(chartData,'PNG',margin,40,500,250);
  canvas.style.display='none';

  // Footer
  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(10);
    doc.text(`Halaman ${i} / ${pageCount}`, doc.internal.pageSize.getWidth()-40, doc.internal.pageSize.getHeight()-10);
  }

  doc.save("Laporan_LSD_LP2B_LombokTimur.pdf");
}
</script>
</body>
</html>
